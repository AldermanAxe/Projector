<html>
	<head>
		<style>
			body{
				overflow:hidden;
				overflow-x:hidden;
				font-size: 30px;
				font-family: "Lucida Console", Monaco, monospace;
			}
			a{
				cursor: pointer; 
				cursor: hand;
			}
			#objectdiv, #buttondiv{
				white-space:nowrap;
				overflow:scroll;
				width:100%;
				height: 10%
			}
			#objectdiv::-webkit-scrollbar, #buttondiv::-webkit-scrollbar{
				width: 0px;
				background: transparent; /* make scrollbar transparent */
			}
			#inputdiv{
				height: 10%;
				overflow:scroll;
				background-color: black;
				color: white;
				width: 100%;
				overflow-y: hidden;
				overflow-x: hidden;
			}
			#maininput{
				background-color:black;
				height:100%;
				color:white;
				display:inline;
				font-size: 30px;
				top:0;
				width:90%;
				padding:0 0 0 0;
				margin:0 0 0 0;
			}
			#gobutton{
				font-size: 30px;
				float:right;
				display:inline;
				height:100%;
				width:10%;
				border-color: white;
				border-width: 2px;
			}
			#displaydiv {
				height: 70%;
				overflow:scroll;
				background-color: black;
				color: white;
				overflow-y: scroll;
				overflow-x: hidden;
				/*for word wrap*/
				white-space: -moz-pre-wrap !important;  /* Mozilla, since 1999 */
				white-space: -webkit-pre-wrap; /*Chrome & Safari */ 
				white-space: -pre-wrap;      /* Opera 4-6 */
				white-space: -o-pre-wrap;    /* Opera 7 */
				white-space: pre-wrap;       /* css-3 */
				word-wrap: break-word;       /* Internet Explorer 5.5+ */
				word-break: break-all;
				white-space: normal;
			}
			.objButton, .funcButton{
				height: 90%;
				padding: 5px 15px 5px 15px;
				margin: 1px 5px 1px 5px;
				font-size: 30px;
			}
		</style>
	</head>
	<body>
		<div id="displaydiv"></div>
		<div id="inputdiv">
			<input id="maininput" type="text"></input>
			<button id="gobutton">Enter</button>
		</div>
		<div id="objectdiv"></div>
		<div id="buttondiv"></div>
		<script>
			document.body.onload = function(){
				//Sets default object string definition. The tags around the code are necessary to replace the string on download
				/***<DEFAULT OBJECT>***/
				projStr = `{
					add:function (name, def){
						that = this;
						that[name] = eval("("+def+")");
						addfun(); 
						addobj();
						return that[name];
					},
					remove:function (name){
						that = this;
						delete that[name];
						addfun(); 
						addobj();
						return name;
					},
					rename:function (oldname, newname){
						that = this;
						that[newname] = that[oldname];
						delete that[oldname];
						addfun(); 
						addobj();
						return oldname + " > " + newname
					},
					load:function (load_name="default"){
						localstring = localStorage.getItem(load_name);
						if (localstring == null) {
							return "local file " + load_name + " not found";						
						} else {
							eval("proj = " + localstring);
							addfun(); 
							addobj();
							return "loaded local " + load_name;
						};
					},
					save:function (save_name="default"){
						localStorage.setItem(save_name,this._toString())
						return "saved local " + save_name;
					},
					save_server:function (save_name="default"){
						//saves the project object to the server
						var xhr = new XMLHttpRequest();
						xhr.open("POST", '../proj/proj_data.aspx', true);
						xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
						xhr.onreadystatechange = function() {//Call a function when the state changes.
							if(xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
								doDisplay("save: " + xhr.responseText);
							}
						}
						xhr.send("codename=" + save_name + "&data=" + encodeURIComponent(this._toString())); 
						
						var xhr2 = new XMLHttpRequest();
						xhr2.open("POST", "../proj/proj_backup.aspx", true);
						xhr2.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
						xhr2.onreadystatechange = function() {//Call a function when the state changes.
							if(xhr2.readyState == XMLHttpRequest.DONE && xhr2.status == 200) {
								doDisplay("backedup" + xhr2.responseText);
							}
						}
						xhr2.send("codename=" + save_name + "&data=" + encodeURIComponent(this._toString())); 
						return "save attempted";
					},
					download:function(filename="newwp.html") {
						document.getElementById('displaydiv').innerHTML = '';		
						let text = document.getElementsByTagName('html')[0].innerHTML;
						let startnum = text.indexOf("/***<DEFAULT" + " OBJECT>***/") + ("/***<DEFAULT" + " OBJECT>***/").length + 1;
						let endnum = text.indexOf("/***</DEFAULT" + " OBJECT>***/");
						text = "<html><body>" + text.substring(0, startnum) + "projStr = \`" + proj._toString().split("\\\\").join("\\\\\\\\").split("\`").join("\\\\\`") + "\`" + text.substring(endnum, text.length) + "</html>";				
						let pom = document.createElement('a');
						pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
						pom.setAttribute('download', filename);
						if (document.createEvent) {
							var event = document.createEvent('MouseEvents');
							event.initEvent('click', true, true);
							pom.dispatchEvent(event);
						}
						else {
							pom.click();
						}
						return("downloaded");
					},
					_toString:function(){
						str = "proj = {";
						for (var property in this) {
							if (this.hasOwnProperty(property)){
								if (typeof this[property] == "object"){
									str += '"' + property + '":' + JSON.stringify(this[property]) + ',\\n';	
								} else if (typeof this[property] == "function") {
									str += '"' + property + '":' + this[property] + ',\\n';
								} else {
									str += '"' + property + '":"' + this[property] + '",\\n';
								}
							}
						}
						str = str.substring(0, str.length - 2);
						str += "};";
						str += "proj._init();";
						str += "proj = proj;";
						return str;
					},
					_init:function(){
					}
				}`;
				/***</DEFAULT OBJECT>***/			
				
				let bdiv = document.getElementById("buttondiv");
				let odiv = document.getElementById("objectdiv");
				let ddiv = document.getElementById('displaydiv');
				let mInput = document.getElementById("maininput");
				let cmdHist = []; //variables for text input behavior
				let cmdHistPos = 0;
				let inputMode = {selected: 0, text:0, parameters:1};
				let g_parameterCallback = function(){;};
				let g_args = [];
				let g_paramNames = [];

				//Creates proj objects from the server file indicated in get parameter
				if (getUrlParameter("source")){//Uses servers source for object
					let param = getUrlParameter("source").replace("%3d", "=");
					let request = new XMLHttpRequest();
					request.open('GET', "../JsonFiles/proj_data_" + param + ".json?rand=" + Date.now(), false);  // `false` makes the request synchronous
					request.send(null);
					if (request.status == 200) {
						proj = eval("proj = " + request.responseText);
					} else {
						alert("source " + param + " failed");
					}
				} else if (getUrlParameter("object")){//Uses object in get parameter
					let param = getUrlParameter("object").replace("%3d", "=");
					proj = eval("proj = " + param);
				} else {//Otherwise uses default object
					proj = eval("proj = " + projStr);
				};
				
				//Initializes Page Setup, Adds Input area Keypress and Enter Button Behavior
				if (isMobile()) {ddiv.style.fontSize = "15px";}; //Changes font size for mobile
				mInput.focus();	//Puts the curser in the text input
				document.onkeydown = onkeypress;
				document.getElementById("gobutton").onclick = function(){onkeypress({keyCode:13});};
				addobj(); //Adds object and function buttons
				addfun();
				ddiv.innerHTML += 'Activated Web Platform<br/><br/>'; //Sends an initialization message
				
				//Utility Functions for page Setup and Behavior
				function doDisplay(result, element){
					if (typeof result != "undefined"){
						//A default callback function to display results to the display div
						if (typeof result == "function"){
							runFun(result);
						} else {
							ddiv = document.getElementById(element || 'displaydiv');
							if (element){
								ddiv.innerHTML += result;			
							} else {
								ddiv.innerHTML += "[Result]<br/>" + result + '<br/><br/>';			
								ddiv.scrollTop = ddiv.scrollHeight;
							};
						};
					};
				};
				function onkeypress(inKey){
					//An activity to take place on a key press in the input div
					try {
						if (inputMode.selected == inputMode.text){
							if (inKey.keyCode == 13) { //when 'enter' is pressed
								command = mInput.value;
								if (command == ""){
									throw "nothing entered";
 								};
								if (command != cmdHist[cmdHist.length - 1]) cmdHist.push(command);
								cmdHistPos = 0;
								//check for strings beginning with '=' and treat them as an eval
								if (command.substring(0, 1) == "=") {
									command = command.substring(1, command.length);
									doDisplay(eval(command));
									mInput.value = "";
								} else if (proj.hasOwnProperty(command)){
									runFun(eval("proj." + command));
														} else {
									
									//convert input with spaces to function call syntax
									if (command.substring(command.length - 1) != ")")
									{
										if(command.includes(" ")){
											command = command.replace(" ", "(") + ")";
										} else {
											command += "()";
										}
									}
									output = eval("proj." + command);
									doDisplay(output);
									mInput.value = "";
								};
								mInput.focus();
							} else if  (inKey.keyCode == 38){ //up arrow to get prior commands
								mInput.value = cmdHist[cmdHist.length - 1 - cmdHistPos];
								if (cmdHistPos <= cmdHist.length - 1) cmdHistPos++;
								mInput.focus();
							} else if  (inKey.keyCode == 40){ //down arrow to get prior commands
								if (cmdHistPos >= 0 ) cmdHistPos--;
								mInput.value = cmdHist[cmdHist.length - 1 - cmdHistPos];
								mInput.focus();
							};
						} else if (inputMode.selected == inputMode.parameters){
							if (inKey.keyCode == 13) { //when 'enter' is pressed
								addval = mInput.value.substring(g_paramNames[g_args.length].length + 2 ,mInput.value.length);
								runFun(g_parameterCallback, g_paramNames, g_args.concat([addval]));
							};		
						};
					} catch(e) {
						doDisplay(e.toString());
					}
				};
				function addobj(objs){
					//Adds object buttons. Ignore hidden objects beginning with '_'
					if (typeof objs == 'undefined'){
						objs = proj;
					}
					odiv.innerHTML = "";
					for (var k in objs) {
						if (objs.hasOwnProperty(k)) {
							if (typeof objs[k] != "function" && k.substring(0,1)!= "_"){
								b = document.createElement("button");
								b.className = "objButton";
								b.innerText = k;
								b.onclick = eval(`x = function(){
									runFun(function(){return JSON.stringify(objs['` + k + `']);});
								}`);
								odiv.appendChild(b);
							}
						}
					};
				};
				function addfun(funs){
					//Adds function buttons. Ignore hidden functions beginning with '_'
					if (typeof funs == 'undefined'){
						funs = proj;
					}
					bdiv.innerHTML = "";
					for (var k in funs) {
						if (funs.hasOwnProperty(k)) {
							if (typeof funs[k] == "function" && k.substring(0,1)!= "_"){
								b = document.createElement("button");
								b.className = "funcButton";
								b.innerText = k;
								b.onclick = eval(`x = function(){
									buttonFun = funs['` + k + `'];
									paramNames = getFunctionParameterNames(buttonFun); //prompt for parameters
									args = [];
									runFun(funs['` + k + `'], paramNames, args);
								}`);
								bdiv.appendChild(b);
							}
						}
					};
				};
				function runFun(callback, paramNames, args, defaults){
					//This is some complex business to run a function one argument at a time. prompting with the default values is the tricky part
					//ideally prior parameters could provide the defaults for later parameters eg function(a=1,b=a){return b;} by default would return 1.
					//but this involves creating a context for these variables and is a bit tricky (though there is a technique with chaining function contexts)
					//so, still waiting on this
					if (typeof defaults == 'undefined'){
						defaults = getFunctionParameterDefaults(callback);
					}
					if (typeof paramNames == 'undefined'){
						paramNames = getFunctionParameterNames(callback);
						args = [];
					};
					if (paramNames.length == args.length){
						var output = callback.apply(proj, args);
						doDisplay(output);
						ddiv.scrollTop = ddiv.scrollHeight;
						inputMode.selected = inputMode.text;
						mInput.value = "";
						if (isMobile()) {
							mInput.blur();
						} else {
							mInput.focus();
						};
					} else {
						g_parameterCallback = callback;
						g_args = args;
						g_paramNames = paramNames;
						label = paramNames[args.length];
						defVal = defaults[args.length] == "" ? "" : eval("("+defaults[args.length]+")");
						prompt = label + ": " + defVal;
						mInput.value = prompt;
						mInput.focus();
						inputMode.selected = inputMode.parameters;
					};
				};
				function getUrlParameter(sParam) {
					//Gets parameters provided to the URL as GET parameters (?x=y)
					var sPageURL = decodeURIComponent(window.location.search.substring(1)),
						sURLVariables = sPageURL.split('&'),
						sParameterName,
						i;
					for (i = 0; i < sURLVariables.length; i++) {
						sParameterName = sURLVariables[i].split('=');
						if (sParameterName[0] == sParam) return sParameterName[1] == undefined ? true : sParameterName[1];
					}
				};
				function getFunctionParameters(func){
					//Returns parameters from a function
					fstring = func.toString();
					firstBracket = fstring.indexOf("(");
					lastBracket = 0; 
					bracketDepth = 0;
					for (var i = firstBracket + 1; i < fstring.length; i++){		
						if (fstring[i] == ")" && bracketDepth == 0) {
							lastBracket = i;
							break;
						} else if (fstring[i] == ")" && bracketDepth != 0) {
							bracketDepth--;
						} else if (fstring[i] == "(") {
							bracketDepth++;
						}
					}
					argstring = fstring.substring(firstBracket + 1, lastBracket);
					return argstring;
				};
				function getFunctionParameterNames(func){
					//Returns the parameter names from a function
					var params = getExpressions(getFunctionParameters(func));
					var paramNames = params.map(function(x){
						if (x.includes("=")){
							return x.substring(0, x.indexOf("="));
						} else {
							return x;
						}
					});
					return paramNames;
				};
				function getFunctionParameterDefaults(func){
					//Returns array of default values from a function
					var params = getExpressions(getFunctionParameters(func));
					var defaultExps = params.map(function(x){
						if (x.includes("=")){
							return x.substring(x.indexOf("=") + 1, x.length);
						} else {
							return "";
						}
					});
					return defaultExps;
				};				
				function getExpressions(inStr){
					//Returns separate javascript expressions from a string of javascript code
					exprs = [];
					bracketDepth = 0;
					startchr = 0;
					quotesymbol = 0;
					for (var endchr = 0; endchr < inStr.length; endchr++){
						if (quotesymbol == 0 && (inStr[endchr] == '"' || inStr[endchr] == "'")){
							quotesymbol = inStr[endchr];
						} else if (quotesymbol != 0 && (inStr[endchr] == quotesymbol)){
							quotesymbol = 0;
						} else if (inStr[endchr] == "[" || inStr[endchr] == "(" || inStr[endchr] == "{"){
							bracketDepth++;
						} else if (inStr[endchr] == "]" || inStr[endchr] == ")" || inStr[endchr] == "}"){
							bracketDepth--;
						};
						if (inStr[endchr] == "," && bracketDepth == 0 && quotesymbol == ""){
							exprs.push(inStr.substring(startchr, endchr));
							startchr = endchr + 1;
						} else if (endchr == inStr.length - 1 && bracketDepth == 0 && quotesymbol == "" ){
							exprs.push(inStr.substring(startchr, endchr + 1));
							startchr = endchr + 1;
						};
					}
					return exprs;
				};	
				function isMobile() {
					//Returns true if page is being viewed on a mobile device, based on the aspect ratio being portrait
					let check = false;
					(function(a){
						if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;
					})(navigator.userAgent||navigator.vendor||window.opera);
					return check;
				};
			};
		</script>
	</body>
</html>
